services:
  rails-app:
    image: ${DEVCONTAINER_IMAGE:-ghcr.io/branchbox/branchbox/devcontainer-rails:latest}
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    pull_policy: ${DEVCONTAINER_PULL_POLICY:-missing}
    init: true
    ipc: host
    volumes:
    - ../..:/workspaces:cached
    - mise-cache:/home/vscode/.local/share/mise
    - ${SHARED_CONFIG_DIR:-../..}/.ai-agents/codex:/home/vscode/.codex
    - ${SHARED_CONFIG_DIR:-../..}/.ai-agents/claude:/home/vscode/.claude
    - ${SHARED_CONFIG_DIR:-../..}/.ai-agents/claude.json:/home/vscode/.claude.json
    - ${SHARED_CONFIG_DIR:-../..}/.ai-agents/gh:/home/vscode/.config/gh
    - ./.github-token.env:/home/vscode/.github-token.env:ro
    - ./.git-signing-key:/home/vscode/.git-signing-key:ro
    - ./.gitconfig.env:/home/vscode/.gitconfig.env:ro
    command: sleep infinity
    env_file:
    - path: ../.env
      required: false
    - path: .branchbox.env
      required: false
    environment:
      DB_HOST: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      CHROME_URL: http://chrome:3000
      SELENIUM_DRIVER_URL: http://chrome:3000/webdriver
    depends_on:
      postgres:
        condition: service_healthy
      chrome:
        condition: service_started
  postgres:
    image: postgres:17
    restart: unless-stopped
    volumes:
    - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
  chrome:
    image: ghcr.io/browserless/chromium
    restart: unless-stopped
    environment:
      CONNECTION_TIMEOUT: 600000
  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    depends_on:
    - rails-app
    env_file:
    - path: .cloudflared.env
      required: false
    command:
    - tunnel
    - --no-autoupdate
    - run
volumes:
  mise-cache: null
  postgres-data: null
