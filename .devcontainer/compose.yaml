services:
  rails-app:
    image: ${DEVCONTAINER_IMAGE:-ghcr.io/branchbox/branchbox/devcontainer-rails:latest}
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    pull_policy: ${DEVCONTAINER_PULL_POLICY:-missing}
    privileged: true
    init: true
    ipc: host
    volumes:
    - ../..:/workspaces:cached
    - dind-data:/var/lib/docker
    - mise-cache:/home/vscode/.local/share/mise
    - ${SHARED_CONFIG_DIR:-../..}/.ai-agents/codex:/home/vscode/.codex
    - ${SHARED_CONFIG_DIR:-../..}/.ai-agents/claude:/home/vscode/.claude
    - ${SHARED_CONFIG_DIR:-../..}/.ai-agents/claude.json:/home/vscode/.claude.json
    - ${SHARED_CONFIG_DIR:-../..}/.ai-agents/gh:/home/vscode/.config/gh
    - ./.github-token.env:/home/vscode/.github-token.env:ro
    - ./.git-signing-key:/home/vscode/.git-signing-key:ro
    - ./.gitconfig.env:/home/vscode/.gitconfig.env:ro
    command: sleep infinity
    env_file:
    - path: ../.env
      required: false
    - path: .branchbox.env
      required: false
    environment:
      SOLID_QUEUE_IN_PUMA: ${SOLID_QUEUE_IN_PUMA:-false}
    depends_on:
    - cloudflared
  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    env_file:
    - path: .cloudflared.env
      required: false
    command:
    - tunnel
    - --no-autoupdate
    - run
volumes:
  dind-data: null
  mise-cache: null
